# Phase 1 API Fixes - Implementation Log
## Date: 2025-11-05

### Summary
Fixed critical bugs discovered during E2E testing that blocked Phase 1 functionality.

### Bugs Fixed

#### 1. RLS Context Bug - params not awaited in withAuth ✅
**File:** `libs/api-utils/index.ts:61`
**Issue:** Next.js 15 changed route params to Promise objects, but withAuth was passing them unresolved
**Fix:** Added `await context.params` before passing to handlers
**Impact:** All project and document API endpoints now work correctly

**Before:**
```typescript
return handler(request, { user, supabase }, context?.params)
```

**After:**
```typescript
const resolvedParams = context?.params ? await context.params : undefined
return handler(request, { user, supabase }, resolvedParams)
```

#### 2. Project Document DELETE params bug ✅
**File:** `app/api/projects/[id]/documents/[docId]/route.ts:12`
**Issue:** Handler signature had nested params type instead of flat
**Fix:** Changed params type from `{ params: { id, docId } }` to `{ id, docId }`

**Before:**
```typescript
params: { params: { id: string; docId: string } }
```

**After:**
```typescript
params: { id: string; docId: string }
```

#### 3. Gemini model retirement ✅
**File:** `libs/ai/client.ts:6`
**Issue:** Gemini 1.5 models retired, causing 404 errors
**Fix:** Updated to gemini-2.5-flash

**Before:**
```typescript
model: 'gemini-1.5-flash-002'
```

**After:**
```typescript
model: 'gemini-2.5-flash'
```

### Test Results

**API Endpoints - All 200 responses:**
- ✅ GET /api/projects/[id]
- ✅ GET /api/projects/[id]/documents
- ✅ POST /api/projects/[id]/documents (8.3s with extraction)
- ✅ DELETE /api/projects/[id]/documents/[docId]

**Document Upload with Gemini Extraction:**
- Upload successful: 200 in 8339ms
- No extraction errors in latest upload
- Graceful degradation working (uploads succeed even if extraction fails)

### Files Modified
1. `libs/api-utils/index.ts` - withAuth params fix
2. `libs/ai/client.ts` - Gemini model update
3. `app/api/projects/[id]/documents/[docId]/route.ts` - DELETE params fix

### Status
✅ All critical Phase 1 API bugs resolved
✅ Document upload/delete working
✅ Gemini extraction functional with 2.5-flash
✅ Error handling prevents upload failures
